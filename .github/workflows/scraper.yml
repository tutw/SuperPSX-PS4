name: SuperPSX Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Verificar archivo base
        run: |
          if [ ! -f "ps4_games_list.json" ]; then
            echo "❌ Archivo ps4_games_list.json no encontrado"
            exit 1
          else
            echo "✅ Archivo ps4_games_list.json encontrado"
          fi

      - name: Scraping SuperPSX
        run: |
          echo "🚀 Iniciando scraping de SuperPSX..."
          python scraper.py

      - name: Verificar archivos generados
        run: |
          echo "📊 Verificando archivos generados:"
          ls -lh *.json
          echo "📈 Estadísticas de archivos:"
          echo "  - games.json: $(wc -l < games.json) líneas"
          echo "  - updates.json: $(wc -l < updates.json) líneas"
          echo "  - DLC.json: $(wc -l < DLC.json) líneas"

      - name: Commit & Push cambios
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add DLC.json games.json updates.json
          git commit -m "🔄 Actualizar enlaces PS4 - $(date -u +'%Y-%m-%d %H:%M:%S') UTC" || echo "Nada que commitear"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/tutw/SuperPSX-PS4.git HEAD:main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Subir archivos como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: ps4-json-files
          path: |
            DLC.json
            games.json
            updates.json
